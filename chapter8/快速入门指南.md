# 快速入门指南

## 环境准备

### 系统要求
- **操作系统**: Windows/Linux/macOS
- **Java版本**: JDK 8 或更高版本
- **构建工具**: Maven 3.3+ 
- **消息中间件**: RabbitMQ 3.6+
- **版本控制**: Git

### 必需软件安装与配置

#### 1. Java开发环境配置
```bash
# 检查Java版本
java -version

# 设置JAVA_HOME环境变量
export JAVA_HOME=/path/to/jdk
export PATH=$JAVA_HOME/bin:$PATH
```

#### 2. Maven构建工具安装配置
```bash
# 下载Maven并解压
wget https://archive.apache.org/dist/maven/maven-3/3.8.1/binaries/apache-maven-3.8.1-bin.tar.gz
tar -xzf apache-maven-3.8.1-bin.tar.gz

# 配置环境变量
export MAVEN_HOME=/path/to/apache-maven-3.8.1
export PATH=$MAVEN_HOME/bin:$PATH

# 验证安装
mvn -version
```

#### 3. RabbitMQ消息中间件安装
```bash
# macOS (使用Homebrew)
brew install rabbitmq

# Ubuntu/Debian
sudo apt-get update
sudo apt-get install rabbitmq-server

# CentOS/RHEL
sudo yum install rabbitmq-server

# 启动RabbitMQ服务
sudo systemctl start rabbitmq-server
sudo systemctl enable rabbitmq-server

# 启用管理插件
sudo rabbitmq-plugins enable rabbitmq_management

# 访问管理界面: http://localhost:15672
# 默认账号: guest/guest
```

## 项目启动步骤

### 1. 代码获取与配置

#### 1.1 克隆项目
```bash
git clone <your-repository-url>
cd chapter8
```

#### 1.2 修改配置文件

**修改Config Server Git凭证** (`config-server/src/main/resources/application.properties`):
```properties
# 替换为实际的Git凭证
spring.cloud.config.server.git.username=your_actual_username
spring.cloud.config.server.git.password=your_actual_password
```

⚠️ **安全提醒**: 生产环境建议使用SSH密钥认证而非用户名密码

### 2. 按序启动服务

#### 2.1 启动Eureka注册中心
```bash
cd eureka-server
mvn clean package
mvn spring-boot:run

# 验证启动成功
curl http://localhost:8889/
```

#### 2.2 启动Config Server
```bash
cd config-server
mvn clean package
mvn spring-boot:run

# 验证配置服务
curl http://localhost:8888/config-client/dev/master
```

#### 2.3 启动Config Client
```bash
cd config-client
mvn clean package
mvn spring-boot:run

# 验证客户端启动
curl http://localhost:8881/hi
```

### 3. 功能验证测试

#### 3.1 基础功能测试
```bash
# 1. 测试配置获取
curl http://localhost:8881/hi
# 预期返回: foo的配置值

# 2. 查看Eureka注册情况
open http://localhost:8889/

# 3. 查看Config Server配置
curl http://localhost:8888/config-client/dev/master
```

#### 3.2 配置刷新测试
```bash
# 1. 修改Git仓库中的配置文件
# 在 https://github.com/forezp/SpringcloudConfig/respo/config-client-dev.properties 中修改foo值

# 2. 触发配置刷新
curl -X POST http://localhost:8881/refresh

# 3. 验证配置更新
curl http://localhost:8881/hi
```

#### 3.3 消息总线测试
```bash
# 1. 同时启动多个Config Client实例
cd config-client
mvn spring-boot:run --server.port=8881 &
mvn spring-boot:run --server.port=8882 &

# 2. 修改Git配置并触发总线刷新
curl -X POST http://localhost:8888/bus/refresh

# 3. 验证所有客户端都收到更新
curl http://localhost:8881/hi
curl http://localhost:8882/hi
```

## 常见问题解决

### Q1: 端口被占用
```bash
# 查找占用端口的进程
lsof -i :8888
lsof -i :8889
lsof -i :8881

# 杀死占用进程
kill -9 <PID>
```

### Q2: Git连接失败
```bash
# 检查网络连接
ping github.com

# 验证Git凭证
git clone https://github.com/forezp/SpringcloudConfig/

# 如果需要SSH方式，修改配置:
# spring.cloud.config.server.git.uri=git@github.com:forezp/SpringcloudConfig.git
```

### Q3: RabbitMQ连接异常
```bash
# 检查RabbitMQ状态
sudo systemctl status rabbitmq-server

# 重启RabbitMQ
sudo systemctl restart rabbitmq-server

# 查看RabbitMQ日志
tail -f /var/log/rabbitmq/rabbit@localhost.log
```

### Q4: 配置刷新不生效
```bash
# 检查@RefreshScope注解
# 确认management端点配置
# 验证RabbitMQ连接状态

# 手动触发单个实例刷新
curl -X POST http://localhost:8881/refresh
```

## 开发调试技巧

### 日志配置优化
```properties
# config-client/src/main/resources/application.properties
logging.level.org.springframework.cloud=DEBUG
logging.level.org.springframework.amqp=DEBUG
logging.pattern.console=%d{HH:mm:ss.SSS} [%thread] %-5level %logger{36} - %msg%n
```

### 远程调试配置
```bash
# 启动时添加JVM调试参数
mvn spring-boot:run -Dspring-boot.run.jvmArguments="-Xdebug -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005"
```

### 性能监控
```bash
# 启用Actuator端点
curl http://localhost:8881/actuator/health
curl http://localhost:8881/actuator/info
```

## 生产环境部署建议

### 1. 安全加固
```properties
# 启用安全认证
management.endpoints.web.exposure.include=health,info
management.endpoint.health.show-details=when_authorized
spring.security.user.name=admin
spring.security.user.password=${ADMIN_PASSWORD}

# 启用HTTPS
server.ssl.key-store=classpath:keystore.p12
server.ssl.key-store-password=${SSL_PASSWORD}
```

### 2. 高可用配置
```yaml
# Config Server集群配置
spring:
  cloud:
    config:
      server:
        git:
          uri: https://github.com/company/config-repo
          repos:
            team-a:
              pattern: team-a-*
              uri: https://github.com/company/team-a-config
            team-b:
              pattern: team-b-*
              uri: https://github.com/company/team-b-config
```

### 3. 监控告警
```java
@RestController
public class HealthController {
    
    @GetMapping("/health")
    public ResponseEntity<Map<String, Object>> health() {
        Map<String, Object> health = new HashMap<>();
        health.put("status", "UP");
        health.put("timestamp", System.currentTimeMillis());
        return ResponseEntity.ok(health);
    }
}
```

通过以上步骤，您就可以成功运行和体验Spring Cloud配置中心的完整功能了！